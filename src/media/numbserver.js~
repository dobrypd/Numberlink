var contentHistory = Array();
var currentInHistory = 0;

var newSite = function(what, dir){
	contentHistory.append({'what':what,'dir':dir});
}

var back = function(){
	alert("BACK");
}

var forw = function(){
	alert("FORW");
}


$('html').ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
        // Only send the token to relative URLs i.e. locally.
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
});

var wantBoard = function() {
	$("#boardsoptions").load('/board/?options', function(response, status, xhr) {
		if (status == "error") {
			var msg = "Wystąpił błąd podczas ładowania: ";
			$("#boardsoptions").html(msg + xhr.status + " " + xhr.statusText);
	  	}
		init_numberlink();
	});
}

var showContent = function(what, dir){
	$("#MainMenu").hide('fast');
	$("#Content").hide('fast');
	$("#Content").load(dir+what+'/ #MainDIV', function(response, status, xhr) {
		if (status == "error") {
			var msg = "Wystąpił błąd podczas ładowania: ";
			$("#Content").html(msg + xhr.status + " " + xhr.statusText);
			}
		switch(what){ //jak się załaduje to odpal:
			case 'board':
				wantBoard();
				break;
			case 'login':
				wantLogin();
				break;
		}
		wantLogin();
	});
	
	$("#Content").show('slow');
}

function logout(){
	$("#Content").load('accounts/logout/')
}

var wantLogin = function() {
	$("form").submit(function() {
		var nazwa = $('#id_username').val();
		var nowe = $('#isnew').attr('checked') ? 1 : 0;
		var haslo = $('#id_password').val();
		$.post('accounts/ajaxlogin/',
			{username: nazwa, password: haslo, isnew: nowe},
			function(json) {
				ret = eval(json);
				if ((ret[1] && !ret[0])) {
					showContent('board', '/');
				}
				else 
					if (!ret[0]) 
						alert("Zła nazwa użytkownika lub hasło");
					else 
						if (ret[0] && !ret[1]) 
							alert("Login zajęty");
						else {
							alert('Zarejestrowano');
							showContent('board', '/');
						}
			}
		)
		return false;
    });
}



var mouseEvent_showInContent = function(what, dir){
	$(".show" + what).click( function(event){
		showContent(what, dir);
	});
}

$(document).ready(function(){
	$("#MainMenu").show('slow');
	
	mouseEvent_showInContent('highscores', '/');
	mouseEvent_showInContent('board', '/');
	
	mouseEvent_showInContent('login', '/accounts/');
	mouseEvent_showInContent('logout', '/accounts/');
	
	$(".showMenu").click( function(event){
		if ($("#MainMenu").css('display') === 'none') {
			$("#MainMenu").show('slow');
		} else {
			$("#MainMenu").hide('slow');
		}
	});
	$(".back").click( function(event){
		back();
	});
	$(".forward").click( function(event){
		forw();
	});
});